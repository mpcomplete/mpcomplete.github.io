import{h as St,I as ae,e as T,i as Ft,j as re,f as $,k as oe,V as ie,l as it,m as E,v as O,D as V,n as H,o as st,p as Et,q as ut,M as q,w as ce,s as Ot,t as le,x as he,y as de,F as ue,z as pe,A as fe,H as ge,R as me}from"./index-DuWR1pN9.js";import{c as xe,R as Ce,S as ye,B as _e,a as ve,b as be,d as Te,A as Me,C as Se}from"./RenderTargetSystem-eFD10Ts0.js";import{S as Vt}from"./Filter-vQ5B_7Xm.js";class we{constructor(){this.isBatchable=!1}reset(){this.isBatchable=!1,this.context=null,this.graphicsData&&(this.graphicsData.destroy(),this.graphicsData=null)}destroy(){this.reset()}}class Pe{constructor(){this.instructions=new ae}init(){this.instructions.reset()}destroy(){this.instructions.destroy(),this.instructions=null}}const wt=class Mt{constructor(t){this._renderer=t,this._managedContexts=new St({renderer:t,type:"resource",name:"graphicsContext"})}init(t){Mt.defaultOptions.bezierSmoothness=(t==null?void 0:t.bezierSmoothness)??Mt.defaultOptions.bezierSmoothness}getContextRenderData(t){return this.getGpuContext(t).graphicsData||this._initContextRenderData(t)}updateGpuContext(t){const e=t._gpuData,s=!!e[this._renderer.uid],n=e[this._renderer.uid]||this._initContext(t);return(t.dirty||!s)&&(s&&n.reset(),n.isBatchable=!1,t.dirty=!1),n}getGpuContext(t){return t._gpuData[this._renderer.uid]||this._initContext(t)}_initContextRenderData(t){const e=new Pe,s=this.getGpuContext(t);return s.graphicsData=e,e.init(),e}_initContext(t){const e=new we;return e.context=t,t._gpuData[this._renderer.uid]=e,this._managedContexts.add(t),e}destroy(){this._managedContexts.destroy(),this._renderer=null}};wt.extension={type:[T.CanvasSystem],name:"graphicsContext"};wt.defaultOptions={bezierSmoothness:.5};let ke=wt;class qt{constructor(t,e){this.state=Vt.for2d(),this.renderer=t,this._adaptor=e,this.renderer.runners.contextChange.add(this),this._managedGraphics=new St({renderer:t,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(t){return!1}addRenderable(t,e){this._managedGraphics.add(t),this.renderer.renderPipes.batch.break(e),e.add(t)}updateRenderable(t){}execute(t){t.isRenderable&&this._adaptor.execute(this,t)}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null}}qt.extension={type:[T.CanvasPipes],name:"graphics"};class Ie{constructor(){this.batches=[],this.batched=!1}destroy(){this.batches.forEach(t=>{Ft.return(t)}),this.batches.length=0}}class Lt{constructor(t,e){this.state=Vt.for2d(),this.renderer=t,this._adaptor=e,this.renderer.runners.contextChange.add(this),this._managedGraphics=new St({renderer:t,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(t){const e=t.context,s=!!t._gpuData,a=this.renderer.graphicsContext.updateGpuContext(e);return!!(a.isBatchable||s!==a.isBatchable)}addRenderable(t,e){const n=this.renderer.graphicsContext.updateGpuContext(t.context);t.didViewUpdate&&this._rebuild(t),n.isBatchable?this._addToBatcher(t,e):(this.renderer.renderPipes.batch.break(e),e.add(t))}updateRenderable(t){const s=this._getGpuDataForRenderable(t).batches;for(let n=0;n<s.length;n++){const a=s[n];a._batcher.updateElement(a)}}execute(t){if(!t.isRenderable)return;const e=this.renderer,s=t.context;if(!e.graphicsContext.getGpuContext(s).batches.length)return;const a=s.customShader||this._adaptor.shader;this.state.blendMode=t.groupBlendMode;const o=a.resources.localUniforms.uniforms;o.uTransformMatrix=t.groupTransform,o.uRound=e._roundPixels|t._roundPixels,xe(t.groupColorAlpha,o.uColor,0),this._adaptor.execute(this,t)}_rebuild(t){const e=this._getGpuDataForRenderable(t),n=this.renderer.graphicsContext.updateGpuContext(t.context);e.destroy(),n.isBatchable&&this._updateBatchesForRenderable(t,e)}_addToBatcher(t,e){const s=this.renderer.renderPipes.batch,n=this._getGpuDataForRenderable(t).batches;for(let a=0;a<n.length;a++){const o=n[a];s.addToBatch(o,e)}}_getGpuDataForRenderable(t){return t._gpuData[this.renderer.uid]||this._initGpuDataForRenderable(t)}_initGpuDataForRenderable(t){const e=new Ie;return t._gpuData[this.renderer.uid]=e,this._managedGraphics.add(t),e}_updateBatchesForRenderable(t,e){const s=t.context,a=this.renderer.graphicsContext.getGpuContext(s),o=this.renderer._roundPixels|t._roundPixels;e.batches=a.batches.map(i=>{const c=Ft.get(re);return i.copyTo(c),c.renderable=t,c.roundPixels=o,c})}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null,this.state=null}}Lt.extension={type:[T.WebGLPipes,T.WebGPUPipes],name:"graphics"};$.add(qt);$.add(Lt);$.add(ke);$.add(oe);class ft extends ie{constructor(t){t instanceof it&&(t={context:t});const{context:e,roundPixels:s,...n}=t||{};super({label:"Graphics",...n}),this.renderPipeId="graphics",e?this.context=e:(this.context=this._ownedContext=new it,this.context.autoGarbageCollect=this.autoGarbageCollect),this.didViewUpdate=!0,this.allowChildren=!1,this.roundPixels=s??!1}set context(t){t!==this._context&&(this._context&&(this._context.off("update",this.onViewUpdate,this),this._context.off("unload",this.unload,this)),this._context=t,this._context.on("update",this.onViewUpdate,this),this._context.on("unload",this.unload,this),this.onViewUpdate())}get context(){return this._context}get bounds(){return this._context.bounds}updateBounds(){}containsPoint(t){return this._context.containsPoint(t)}destroy(t){this._ownedContext&&!t?this._ownedContext.destroy(t):(t===!0||(t==null?void 0:t.context)===!0)&&this._context.destroy(t),this._ownedContext=null,this._context=null,super.destroy(t)}_onTouch(t){this._gcLastUsed=t,this._context._gcLastUsed=t}_callContextMethod(t,e){return this.context[t](...e),this}setFillStyle(...t){return this._callContextMethod("setFillStyle",t)}setStrokeStyle(...t){return this._callContextMethod("setStrokeStyle",t)}fill(...t){return this._callContextMethod("fill",t)}stroke(...t){return this._callContextMethod("stroke",t)}texture(...t){return this._callContextMethod("texture",t)}beginPath(){return this._callContextMethod("beginPath",[])}cut(){return this._callContextMethod("cut",[])}arc(...t){return this._callContextMethod("arc",t)}arcTo(...t){return this._callContextMethod("arcTo",t)}arcToSvg(...t){return this._callContextMethod("arcToSvg",t)}bezierCurveTo(...t){return this._callContextMethod("bezierCurveTo",t)}closePath(){return this._callContextMethod("closePath",[])}ellipse(...t){return this._callContextMethod("ellipse",t)}circle(...t){return this._callContextMethod("circle",t)}path(...t){return this._callContextMethod("path",t)}lineTo(...t){return this._callContextMethod("lineTo",t)}moveTo(...t){return this._callContextMethod("moveTo",t)}quadraticCurveTo(...t){return this._callContextMethod("quadraticCurveTo",t)}rect(...t){return this._callContextMethod("rect",t)}roundRect(...t){return this._callContextMethod("roundRect",t)}poly(...t){return this._callContextMethod("poly",t)}regularPoly(...t){return this._callContextMethod("regularPoly",t)}roundPoly(...t){return this._callContextMethod("roundPoly",t)}roundShape(...t){return this._callContextMethod("roundShape",t)}filletRect(...t){return this._callContextMethod("filletRect",t)}chamferRect(...t){return this._callContextMethod("chamferRect",t)}star(...t){return this._callContextMethod("star",t)}svg(...t){return this._callContextMethod("svg",t)}restore(...t){return this._callContextMethod("restore",t)}save(){return this._callContextMethod("save",[])}getTransform(){return this.context.getTransform()}resetTransform(){return this._callContextMethod("resetTransform",[])}rotateTransform(...t){return this._callContextMethod("rotate",t)}scaleTransform(...t){return this._callContextMethod("scale",t)}setTransform(...t){return this._callContextMethod("setTransform",t)}transform(...t){return this._callContextMethod("transform",t)}translateTransform(...t){return this._callContextMethod("translate",t)}clear(){return this._callContextMethod("clear",[])}get fillStyle(){return this._context.fillStyle}set fillStyle(t){this._context.fillStyle=t}get strokeStyle(){return this._context.strokeStyle}set strokeStyle(t){this._context.strokeStyle=t}clone(t=!1){return t?new ft(this._context.clone()):(this._ownedContext=null,new ft(this._context))}lineStyle(t,e,s){E(O,"Graphics#lineStyle is no longer needed. Use Graphics#setStrokeStyle to set the stroke style.");const n={};return t&&(n.width=t),e&&(n.color=e),s&&(n.alpha=s),this.context.strokeStyle=n,this}beginFill(t,e){E(O,"Graphics#beginFill is no longer needed. Use Graphics#fill to fill the shape with the desired style.");const s={};return t!==void 0&&(s.color=t),e!==void 0&&(s.alpha=e),this.context.fillStyle=s,this}endFill(){E(O,"Graphics#endFill is no longer needed. Use Graphics#fill to fill the shape with the desired style."),this.context.fill();const t=this.context.strokeStyle;return(t.width!==it.defaultStrokeStyle.width||t.color!==it.defaultStrokeStyle.color||t.alpha!==it.defaultStrokeStyle.alpha)&&this.context.stroke(),this}drawCircle(...t){return E(O,"Graphics#drawCircle has been renamed to Graphics#circle"),this._callContextMethod("circle",t)}drawEllipse(...t){return E(O,"Graphics#drawEllipse has been renamed to Graphics#ellipse"),this._callContextMethod("ellipse",t)}drawPolygon(...t){return E(O,"Graphics#drawPolygon has been renamed to Graphics#poly"),this._callContextMethod("poly",t)}drawRect(...t){return E(O,"Graphics#drawRect has been renamed to Graphics#rect"),this._callContextMethod("rect",t)}drawRoundedRect(...t){return E(O,"Graphics#drawRoundedRect has been renamed to Graphics#roundRect"),this._callContextMethod("roundRect",t)}drawStar(...t){return E(O,"Graphics#drawStar has been renamed to Graphics#star"),this._callContextMethod("star",t)}}let nt;function Ut(r){const t=V.get().createCanvas(6,1),e=t.getContext("2d");return e.fillStyle=r,e.fillRect(0,0,6,1),t}function Nt(){if(nt!==void 0)return nt;try{const r=Ut("#ff00ff"),t=Ut("#ffff00"),s=V.get().createCanvas(6,1).getContext("2d");s.globalCompositeOperation="multiply",s.drawImage(r,0,0),s.drawImage(t,2,0);const n=s.getImageData(2,0,1,1);if(!n)nt=!1;else{const a=n.data;nt=a[0]===255&&a[1]===0&&a[2]===0}}catch{nt=!1}return nt}const d={canvas:null,convertTintToImage:!1,cacheStepsPerColorChannel:8,canUseMultiply:Nt(),tintMethod:null,_canvasSourceCache:new WeakMap,_unpremultipliedCache:new WeakMap,getCanvasSource:r=>{const t=r.source,e=t==null?void 0:t.resource;if(!e)return null;const s=t.alphaMode==="premultiplied-alpha",n=t.resourceWidth??t.pixelWidth,a=t.resourceHeight??t.pixelHeight,o=n!==t.pixelWidth||a!==t.pixelHeight;if(s){if((e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas)&&!o)return e;const i=d._unpremultipliedCache.get(t);if((i==null?void 0:i.resourceId)===t._resourceId)return i.canvas}if(e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Int8Array||e instanceof Uint16Array||e instanceof Int16Array||e instanceof Uint32Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof ArrayBuffer){const i=d._canvasSourceCache.get(t);if((i==null?void 0:i.resourceId)===t._resourceId)return i.canvas;const c=V.get().createCanvas(t.pixelWidth,t.pixelHeight),h=c.getContext("2d"),l=h.createImageData(t.pixelWidth,t.pixelHeight),f=l.data,_=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);if(t.format==="bgra8unorm")for(let u=0;u<f.length&&u+3<_.length;u+=4)f[u]=_[u+2],f[u+1]=_[u+1],f[u+2]=_[u],f[u+3]=_[u+3];else f.set(_.subarray(0,f.length));return h.putImageData(l,0,0),d._canvasSourceCache.set(t,{canvas:c,resourceId:t._resourceId}),c}if(s){const i=V.get().createCanvas(t.pixelWidth,t.pixelHeight),c=i.getContext("2d",{willReadFrequently:!0});i.width=t.pixelWidth,i.height=t.pixelHeight,c.drawImage(e,0,0);const h=c.getImageData(0,0,i.width,i.height),l=h.data;for(let f=0;f<l.length;f+=4){const _=l[f+3];if(_>0){const u=255/_;l[f]=Math.min(255,l[f]*u+.5),l[f+1]=Math.min(255,l[f+1]*u+.5),l[f+2]=Math.min(255,l[f+2]*u+.5)}}return c.putImageData(h,0,0),d._unpremultipliedCache.set(t,{canvas:i,resourceId:t._resourceId}),i}if(o){const i=d._canvasSourceCache.get(t);if((i==null?void 0:i.resourceId)===t._resourceId)return i.canvas;const c=V.get().createCanvas(t.pixelWidth,t.pixelHeight),h=c.getContext("2d");return c.width=t.pixelWidth,c.height=t.pixelHeight,h.drawImage(e,0,0),d._canvasSourceCache.set(t,{canvas:c,resourceId:t._resourceId}),c}return e},getTintedCanvas:(r,t)=>{const e=r.texture,s=st.shared.setValue(t).toHex(),n=e.tintCache||(e.tintCache={}),a=n[s],o=e.source._resourceId;if((a==null?void 0:a.tintId)===o)return a;const i=a&&"getContext"in a?a:V.get().createCanvas();return d.tintMethod(e,t,i),i.tintId=o,n[s]=i,n[s]},getTintedPattern:(r,t)=>{const e=st.shared.setValue(t).toHex(),s=r.patternCache||(r.patternCache={}),n=r.source._resourceId;let a=s[e];return(a==null?void 0:a.tintId)===n||(d.canvas||(d.canvas=V.get().createCanvas()),d.tintMethod(r,t,d.canvas),a=d.canvas.getContext("2d").createPattern(d.canvas,"repeat"),a.tintId=n,s[e]=a),a},applyPatternTransform:(r,t,e=!0)=>{if(!t)return;const s=r;if(!s.setTransform)return;const n=globalThis.DOMMatrix;if(!n)return;const a=new n([t.a,t.b,t.c,t.d,t.tx,t.ty]);s.setTransform(e?a.inverse():a)},tintWithMultiply:(r,t,e)=>{const s=e.getContext("2d"),n=r.frame.clone(),a=r.source._resolution??r.source.resolution??1,o=r.rotate;n.x*=a,n.y*=a,n.width*=a,n.height*=a;const i=H.isVertical(o),c=i?n.height:n.width,h=i?n.width:n.height;e.width=Math.ceil(c),e.height=Math.ceil(h),s.save(),s.fillStyle=st.shared.setValue(t).toHex(),s.fillRect(0,0,c,h),s.globalCompositeOperation="multiply";const l=d.getCanvasSource(r);if(!l){s.restore();return}o&&d._applyInverseRotation(s,o,n.width,n.height),s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.globalCompositeOperation="destination-atop",s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.restore()},tintWithOverlay:(r,t,e)=>{const s=e.getContext("2d"),n=r.frame.clone(),a=r.source._resolution??r.source.resolution??1,o=r.rotate;n.x*=a,n.y*=a,n.width*=a,n.height*=a;const i=H.isVertical(o),c=i?n.height:n.width,h=i?n.width:n.height;e.width=Math.ceil(c),e.height=Math.ceil(h),s.save(),s.globalCompositeOperation="copy",s.fillStyle=st.shared.setValue(t).toHex(),s.fillRect(0,0,c,h),s.globalCompositeOperation="destination-atop";const l=d.getCanvasSource(r);if(!l){s.restore();return}o&&d._applyInverseRotation(s,o,n.width,n.height),s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.restore()},tintWithPerPixel:(r,t,e)=>{const s=e.getContext("2d"),n=r.frame.clone(),a=r.source._resolution??r.source.resolution??1,o=r.rotate;n.x*=a,n.y*=a,n.width*=a,n.height*=a;const i=H.isVertical(o),c=i?n.height:n.width,h=i?n.width:n.height;e.width=Math.ceil(c),e.height=Math.ceil(h),s.save(),s.globalCompositeOperation="copy";const l=d.getCanvasSource(r);if(!l){s.restore();return}o&&d._applyInverseRotation(s,o,n.width,n.height),s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.restore();const f=t>>16&255,_=t>>8&255,u=t&255,C=s.getImageData(0,0,c,h),v=C.data;for(let x=0;x<v.length;x+=4)v[x]=v[x]*f/255,v[x+1]=v[x+1]*_/255,v[x+2]=v[x+2]*u/255;s.putImageData(C,0,0)},_applyInverseRotation:(r,t,e,s)=>{const n=H.inv(t),a=H.uX(n),o=H.uY(n),i=H.vX(n),c=H.vY(n),h=-Math.min(0,a*e,i*s,a*e+i*s),l=-Math.min(0,o*e,c*s,o*e+c*s);r.transform(a,o,i,c,h,l)}};d.tintMethod=d.canUseMultiply?d.tintWithMultiply:d.tintWithPerPixel;const Pt=class Q{static _getPatternRepeat(t,e){const s=t&&t!=="clamp-to-edge",n=e&&e!=="clamp-to-edge";return s&&n?"repeat":s?"repeat-x":n?"repeat-y":"no-repeat"}start(t,e,s){}execute(t,e){var i,c,h,l;const s=e.elements;if(!s||!s.length)return;const n=t.renderer,a=n.canvasContext,o=a.activeContext;for(let f=0;f<s.length;f++){const _=s[f];if(!_.packAsQuad)continue;const u=_,C=u.texture,v=C?d.getCanvasSource(C):null;if(!v)continue;const x=C.source.style,B=a.smoothProperty,L=x.scaleMode!=="nearest";o[B]!==L&&(o[B]=L),a.setBlendMode(e.blendMode);const W=((i=n.globalUniforms.globalUniformData)==null?void 0:i.worldColor)??4294967295,w=u.color,M=(W>>>24&255)/255,J=(w>>>24&255)/255,ct=((c=n.filter)==null?void 0:c.alphaMultiplier)??1,at=M*J*ct;if(at<=0)continue;o.globalAlpha=at;const rt=W&16777215,Z=w&16777215,P=Et(ut(Z,rt)),I=C.frame,R=x.addressModeU??x.addressMode,gt=x.addressModeV??x.addressMode,ot=Q._getPatternRepeat(R,gt),N=C.source._resolution??C.source.resolution??1,K=(l=(h=u.renderable)==null?void 0:h.renderGroup)==null?void 0:l.isCachedAsTexture,m=I.x*N,y=I.y*N,b=I.width*N,Y=I.height*N,G=u.bounds,k=n.renderTarget.renderTarget.isRoot,U=G.minX,F=G.minY,A=G.maxX-G.minX,D=G.maxY-G.minY,j=C.rotate,p=C.uvs,z=Math.min(p.x0,p.x1,p.x2,p.x3,p.y0,p.y1,p.y2,p.y3),X=Math.max(p.x0,p.x1,p.x2,p.x3,p.y0,p.y1,p.y2,p.y3),S=ot!=="no-repeat"&&(z<0||X>1),mt=j&&!(!S&&(P!==16777215||j));mt?(Q._tempPatternMatrix.copyFrom(u.transform),H.matrixAppendRotationInv(Q._tempPatternMatrix,j,U,F,A,D),a.setContextTransform(Q._tempPatternMatrix,u.roundPixels===1,void 0,K&&k)):a.setContextTransform(u.transform,u.roundPixels===1,void 0,K&&k);const lt=mt?0:U,ht=mt?0:F,xt=A,Ct=D;if(S){let yt=v;const tt=P!==16777215&&!j,et=I.width<=C.source.width&&I.height<=C.source.height;tt&&et&&(yt=d.getTintedCanvas({texture:C},P));const _t=o.createPattern(yt,ot);if(!_t)continue;const It=xt,Rt=Ct;if(It===0||Rt===0)continue;const Gt=1/It,Bt=1/Rt,At=(p.x1-p.x0)*Gt,Dt=(p.y1-p.y0)*Gt,Ht=(p.x3-p.x0)*Bt,Wt=(p.y3-p.y0)*Bt,ne=p.x0-At*lt-Ht*ht,se=p.y0-Dt*lt-Wt*ht,vt=C.source.pixelWidth,bt=C.source.pixelHeight;Q._tempPatternMatrix.set(At*vt,Dt*bt,Ht*vt,Wt*bt,ne*vt,se*bt),d.applyPatternTransform(_t,Q._tempPatternMatrix),o.fillStyle=_t,o.fillRect(lt,ht,xt,Ct)}else{const tt=P!==16777215||j?d.getTintedCanvas({texture:C},P):v,et=tt!==v;o.drawImage(tt,et?0:m,et?0:y,et?tt.width:b,et?tt.height:Y,lt,ht,xt,Ct)}}}};Pt._tempPatternMatrix=new q;Pt.extension={type:[T.CanvasPipesAdaptor],name:"batch"};let Re=Pt;class Yt{constructor(t){this._colorStack=[],this._colorStackIndex=0,this._currentColor=0,this._renderer=t}buildStart(){this._colorStack[0]=15,this._colorStackIndex=1,this._currentColor=15}push(t,e,s){this._renderer.renderPipes.batch.break(s);const n=this._colorStack;n[this._colorStackIndex]=n[this._colorStackIndex-1]&t.mask;const a=this._colorStack[this._colorStackIndex];a!==this._currentColor&&(this._currentColor=a,s.add({renderPipeId:"colorMask",colorMask:a,canBundle:!1})),this._colorStackIndex++}pop(t,e,s){this._renderer.renderPipes.batch.break(s);const n=this._colorStack;this._colorStackIndex--;const a=n[this._colorStackIndex-1];a!==this._currentColor&&(this._currentColor=a,s.add({renderPipeId:"colorMask",colorMask:a,canBundle:!1}))}execute(t){}destroy(){this._renderer=null,this._colorStack=null}}Yt.extension={type:[T.CanvasPipes],name:"colorMask"};function Ge(r,t,e,s,n,a){a=Math.max(0,Math.min(a,Math.min(s,n)/2)),r.moveTo(t+a,e),r.lineTo(t+s-a,e),r.quadraticCurveTo(t+s,e,t+s,e+a),r.lineTo(t+s,e+n-a),r.quadraticCurveTo(t+s,e+n,t+s-a,e+n),r.lineTo(t+a,e+n),r.quadraticCurveTo(t,e+n,t,e+n-a),r.lineTo(t,e+a),r.quadraticCurveTo(t,e,t+a,e)}function jt(r,t){switch(t.type){case"rectangle":{const e=t;r.rect(e.x,e.y,e.width,e.height);break}case"roundedRectangle":{const e=t;Ge(r,e.x,e.y,e.width,e.height,e.radius);break}case"circle":{const e=t;r.moveTo(e.x+e.radius,e.y),r.arc(e.x,e.y,e.radius,0,Math.PI*2);break}case"ellipse":{const e=t;r.ellipse?(r.moveTo(e.x+e.halfWidth,e.y),r.ellipse(e.x,e.y,e.halfWidth,e.halfHeight,0,0,Math.PI*2)):(r.save(),r.translate(e.x,e.y),r.scale(e.halfWidth,e.halfHeight),r.moveTo(1,0),r.arc(0,0,1,0,Math.PI*2),r.restore());break}case"triangle":{const e=t;r.moveTo(e.x,e.y),r.lineTo(e.x2,e.y2),r.lineTo(e.x3,e.y3),r.closePath();break}case"polygon":default:{const e=t,s=e.points;if(!(s!=null&&s.length))break;r.moveTo(s[0],s[1]);for(let n=2;n<s.length;n+=2)r.lineTo(s[n],s[n+1]);e.closePath&&r.closePath();break}}}function Be(r,t){if(!(t!=null&&t.length))return!1;for(let e=0;e<t.length;e++){const s=t[e];if(!(s!=null&&s.shape))continue;const n=s.transform,a=n&&!n.isIdentity();a&&(r.save(),r.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)),jt(r,s.shape),a&&r.restore()}return!0}class zt{constructor(t){this._warnedMaskTypes=new Set,this._canvasMaskStack=[],this._renderer=t}push(t,e,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"stencilMask",action:"pushMaskBegin",mask:t,inverse:e._maskOptions.inverse,canBundle:!1})}pop(t,e,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"stencilMask",action:"popMaskEnd",mask:t,inverse:e._maskOptions.inverse,canBundle:!1})}execute(t){var l,f,_;if(t.action!=="pushMaskBegin"&&t.action!=="popMaskEnd")return;const e=this._renderer,s=e.canvasContext,n=s==null?void 0:s.activeContext;if(!n)return;if(t.action==="popMaskEnd"){this._canvasMaskStack.pop()&&n.restore();return}t.inverse&&this._warnOnce("inverse","CanvasRenderer: inverse masks are not supported on Canvas2D; ignoring inverse flag.");const a=t.mask.mask;if(!(a instanceof ft)){this._warnOnce("nonGraphics","CanvasRenderer: only Graphics masks are supported in Canvas2D; skipping mask."),this._canvasMaskStack.push(!1);return}const o=a,i=(l=o.context)==null?void 0:l.instructions;if(!(i!=null&&i.length)){this._canvasMaskStack.push(!1);return}n.save(),s.setContextTransform(o.groupTransform,(e._roundPixels|o._roundPixels)===1),n.beginPath();let c=!1,h=!1;for(let u=0;u<i.length;u++){const C=i[u],v=C.action;if(v!=="fill"&&v!=="stroke")continue;const x=C.data,B=(f=x==null?void 0:x.path)==null?void 0:f.shapePath;if(!((_=B==null?void 0:B.shapePrimitives)!=null&&_.length))continue;const L=B.shapePrimitives;for(let W=0;W<L.length;W++){const w=L[W];if(!(w!=null&&w.shape))continue;const M=w.transform,J=M&&!M.isIdentity();J&&(n.save(),n.transform(M.a,M.b,M.c,M.d,M.tx,M.ty)),jt(n,w.shape),h=Be(n,w.holes)||h,c=!0,J&&n.restore()}}if(!c){n.restore(),this._canvasMaskStack.push(!1);return}h?n.clip("evenodd"):n.clip(),this._canvasMaskStack.push(!0)}destroy(){this._renderer=null,this._warnedMaskTypes=null,this._canvasMaskStack=null}_warnOnce(t,e){this._warnedMaskTypes.has(t)||(this._warnedMaskTypes.add(t),ce(e))}}zt.extension={type:[T.CanvasPipes],name:"stencilMask"};const g="source-over";function Ae(){const r=Nt(),t=Object.create(null);return t.inherit=g,t.none=g,t.normal="source-over",t.add="lighter",t.multiply=r?"multiply":g,t.screen=r?"screen":g,t.overlay=r?"overlay":g,t.darken=r?"darken":g,t.lighten=r?"lighten":g,t["color-dodge"]=r?"color-dodge":g,t["color-burn"]=r?"color-burn":g,t["hard-light"]=r?"hard-light":g,t["soft-light"]=r?"soft-light":g,t.difference=r?"difference":g,t.exclusion=r?"exclusion":g,t.saturation=r?"saturation":g,t.color=r?"color":g,t.luminosity=r?"luminosity":g,t["linear-burn"]=r?"color-burn":g,t["linear-dodge"]=r?"color-dodge":g,t["linear-light"]=r?"hard-light":g,t["pin-light"]=r?"hard-light":g,t["vivid-light"]=r?"hard-light":g,t["hard-mix"]=g,t.negation=r?"difference":g,t["normal-npm"]=t.normal,t["add-npm"]=t.add,t["screen-npm"]=t.screen,t.erase="destination-out",t.subtract=g,t.divide=g,t.min=g,t.max=g,t}const De=new q;class Xt{constructor(t){this.activeResolution=1,this.smoothProperty="imageSmoothingEnabled",this.blendModes=Ae(),this._activeBlendMode="normal",this._projTransform=null,this._outerBlend=!1,this._warnedBlendModes=new Set,this._renderer=t}resolutionChange(t){this.activeResolution=t}init(){const t=this._renderer.background.alpha<1;if(this.rootContext=this._renderer.canvas.getContext("2d",{alpha:t}),this.activeContext=this.rootContext,this.activeResolution=this._renderer.resolution,!this.rootContext.imageSmoothingEnabled){const e=this.rootContext;e.webkitImageSmoothingEnabled?this.smoothProperty="webkitImageSmoothingEnabled":e.mozImageSmoothingEnabled?this.smoothProperty="mozImageSmoothingEnabled":e.oImageSmoothingEnabled?this.smoothProperty="oImageSmoothingEnabled":e.msImageSmoothingEnabled&&(this.smoothProperty="msImageSmoothingEnabled")}}setContextTransform(t,e,s,n){var h;const a=n?q.IDENTITY:((h=this._renderer.globalUniforms.globalUniformData)==null?void 0:h.worldTransformMatrix)||q.IDENTITY;let o=De;o.copyFrom(a),o.append(t);const i=this._projTransform,c=this.activeResolution;if(s=s||c,i){const l=q.shared;l.copyFrom(o),l.prepend(i),o=l}e?this.activeContext.setTransform(o.a*s,o.b*s,o.c*s,o.d*s,o.tx*c|0,o.ty*c|0):this.activeContext.setTransform(o.a*s,o.b*s,o.c*s,o.d*s,o.tx*c,o.ty*c)}clear(t,e){const s=this.activeContext,n=this._renderer;if(s.clearRect(0,0,n.width,n.height),t){const a=st.shared.setValue(t);s.globalAlpha=e??a.alpha,s.fillStyle=a.toHex(),s.fillRect(0,0,n.width,n.height),s.globalAlpha=1}}setBlendMode(t){if(this._activeBlendMode===t)return;this._activeBlendMode=t,this._outerBlend=!1;const e=this.blendModes[t];if(!e){this._warnedBlendModes.has(t)||(console.warn(`CanvasRenderer: blend mode "${t}" is not supported in Canvas2D; falling back to "source-over".`),this._warnedBlendModes.add(t)),this.activeContext.globalCompositeOperation="source-over";return}this.activeContext.globalCompositeOperation=e}destroy(){this.rootContext=null,this.activeContext=null,this._warnedBlendModes.clear()}}Xt.extension={type:[T.CanvasSystem],name:"canvasContext"};class $t{constructor(){this.maxTextures=16,this.maxBatchableTextures=16,this.maxUniformBindings=0}init(){}}$t.extension={type:[T.CanvasSystem],name:"limits"};const He="#808080",dt=new q,We=new q,Ue=new q,Tt=new q;function Fe(r,t,e){r.beginPath();for(let s=0;s<e.length;s+=3){const n=e[s]*2,a=e[s+1]*2,o=e[s+2]*2;r.moveTo(t[n],t[n+1]),r.lineTo(t[a],t[a+1]),r.lineTo(t[o],t[o+1]),r.closePath()}r.fill()}function Ee(r){return`#${(r&16777215).toString(16).padStart(6,"0")}`}function Oe(r,t,e,s,n,a){a=Math.max(0,Math.min(a,Math.min(s,n)/2)),r.moveTo(t+a,e),r.lineTo(t+s-a,e),r.quadraticCurveTo(t+s,e,t+s,e+a),r.lineTo(t+s,e+n-a),r.quadraticCurveTo(t+s,e+n,t+s-a,e+n),r.lineTo(t+a,e+n),r.quadraticCurveTo(t,e+n,t,e+n-a),r.lineTo(t,e+a),r.quadraticCurveTo(t,e,t+a,e)}function pt(r,t){switch(t.type){case"rectangle":{const e=t;r.rect(e.x,e.y,e.width,e.height);break}case"roundedRectangle":{const e=t;Oe(r,e.x,e.y,e.width,e.height,e.radius);break}case"circle":{const e=t;r.arc(e.x,e.y,e.radius,0,Math.PI*2);break}case"ellipse":{const e=t;r.ellipse?r.ellipse(e.x,e.y,e.halfWidth,e.halfHeight,0,0,Math.PI*2):(r.save(),r.translate(e.x,e.y),r.scale(e.halfWidth,e.halfHeight),r.arc(0,0,1,0,Math.PI*2),r.restore());break}case"triangle":{const e=t;r.moveTo(e.x,e.y),r.lineTo(e.x2,e.y2),r.lineTo(e.x3,e.y3),r.closePath();break}case"polygon":default:{const e=t,s=e.points;if(!(s!=null&&s.length))break;r.moveTo(s[0],s[1]);for(let n=2;n<s.length;n+=2)r.lineTo(s[n],s[n+1]);e.closePath&&r.closePath();break}}}function Ve(r,t){if(!(t!=null&&t.length))return!1;for(let e=0;e<t.length;e++){const s=t[e];if(!(s!=null&&s.shape))continue;const n=s.transform,a=n&&!n.isIdentity();a&&(r.save(),r.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)),pt(r,s.shape),a&&r.restore()}return!0}function qe(r,t,e,s){const n=r.fill;if(n instanceof ue){n.buildGradient();const o=n.texture;if(o){const i=d.getTintedPattern(o,t),c=e?Tt.copyFrom(e).scale(o.source.pixelWidth,o.source.pixelHeight):Tt.copyFrom(n.transform);return s&&!r.textureSpace&&c.append(s),d.applyPatternTransform(i,c),i}}if(n instanceof pe){const o=d.getTintedPattern(n.texture,t);return d.applyPatternTransform(o,n.transform),o}const a=r.texture;if(a&&a!==Ot.WHITE){if(!a.source.resource)return He;const o=d.getTintedPattern(a,t),i=e?Tt.copyFrom(e).scale(a.source.pixelWidth,a.source.pixelHeight):r.matrix;return d.applyPatternTransform(o,i),o}return Ee(t)}class Jt{constructor(){this.shader=null}contextChange(t){}execute(t,e){var L,W,w,M,J,ct,at;const s=t.renderer,n=s.canvasContext,a=n.activeContext,o=e.groupTransform,i=((L=s.globalUniforms.globalUniformData)==null?void 0:L.worldColor)??4294967295,c=e.groupColorAlpha,h=(i>>>24&255)/255,l=(c>>>24&255)/255,f=((W=s.filter)==null?void 0:W.alphaMultiplier)??1,_=h*l*f;if(_<=0)return;const u=i&16777215,C=c&16777215,v=Et(ut(C,u)),x=s._roundPixels|e._roundPixels;a.save(),n.setContextTransform(o,x===1),n.setBlendMode(e.groupBlendMode);const B=e.context.instructions;for(let rt=0;rt<B.length;rt++){const Z=B[rt];if(Z.action==="texture"){const m=Z.data,y=m.image,b=y?d.getCanvasSource(y):null;if(!b)continue;const Y=m.alpha*_;if(Y<=0)continue;const G=ut(m.style,v);a.globalAlpha=Y;let k=b;G!==16777215&&(k=d.getTintedCanvas({texture:y},G));const U=y.frame,F=y.source._resolution??y.source.resolution??1;let A=U.x*F,D=U.y*F;const j=U.width*F,p=U.height*F;k!==b&&(A=0,D=0);const z=m.transform,X=z&&!z.isIdentity(),S=y.rotate;X||S?(dt.copyFrom(o),X&&dt.append(z),S&&H.matrixAppendRotationInv(dt,S,m.dx,m.dy,m.dw,m.dh),n.setContextTransform(dt,x===1)):n.setContextTransform(o,x===1),a.drawImage(k,A,D,k===b?j:k.width,k===b?p:k.height,S?0:m.dx,S?0:m.dy,m.dw,m.dh),(X||S)&&n.setContextTransform(o,x===1);continue}const P=Z.data,I=(w=P==null?void 0:P.path)==null?void 0:w.shapePath;if(!((M=I==null?void 0:I.shapePrimitives)!=null&&M.length))continue;const R=P.style,gt=ut(R.color,v),ot=R.alpha*_;if(ot<=0)continue;const N=Z.action==="stroke";if(a.globalAlpha=ot,N){const m=R;a.lineWidth=m.width,a.lineCap=m.cap,a.lineJoin=m.join,a.miterLimit=m.miterLimit}const K=I.shapePrimitives;if(!N&&((at=(ct=(J=P.hole)==null?void 0:J.shapePath)==null?void 0:ct.shapePrimitives)!=null&&at.length)){const m=K[K.length-1];m.holes=P.hole.shapePath.shapePrimitives}for(let m=0;m<K.length;m++){const y=K[m];if(!(y!=null&&y.shape))continue;const b=y.transform,Y=b&&!b.isIdentity(),G=R.texture&&R.texture!==Ot.WHITE,k=R.textureSpace==="global"?b:null,U=G?le(We,R,y.shape,k):null,F=Y?Ue.copyFrom(o).append(b):o,A=qe(R,gt,U,F);if(Y&&(a.save(),a.transform(b.a,b.b,b.c,b.d,b.tx,b.ty)),N){const D=R;if(D.alignment!==.5&&!D.pixelLine){const p=[],z=[],X=[],S=he[y.shape.type];if(S!=null&&S.build(y.shape,p)){const kt=y.shape.closePath??!0;de(p,D,!1,kt,z,X),a.fillStyle=A,Fe(a,z,X)}else a.strokeStyle=A,a.beginPath(),pt(a,y.shape),a.stroke()}else a.strokeStyle=A,a.beginPath(),pt(a,y.shape),a.stroke()}else a.fillStyle=A,a.beginPath(),pt(a,y.shape),Ve(a,y.holes)?a.fill("evenodd"):a.fill();Y&&a.restore()}}a.restore()}destroy(){this.shader=null}}Jt.extension={type:[T.CanvasPipesAdaptor],name:"graphics"};class Le{init(t,e){this._renderer=t,this._renderTargetSystem=e}initGpuRenderTarget(t){const e=t.colorTexture,{canvas:s,context:n}=this._ensureCanvas(e);return{canvas:s,context:n,width:s.width,height:s.height}}resizeGpuRenderTarget(t){const e=t.colorTexture,{canvas:s}=this._ensureCanvas(e);s.width=t.pixelWidth,s.height=t.pixelHeight}startRenderPass(t,e,s,n){const a=this._renderTargetSystem.getGpuRenderTarget(t);this._renderer.canvasContext.activeContext=a.context,this._renderer.canvasContext.activeResolution=t.resolution,e&&this.clear(t,e,s,n)}clear(t,e,s,n){const o=this._renderTargetSystem.getGpuRenderTarget(t).context,i=n||{x:0,y:0,width:t.pixelWidth,height:t.pixelHeight};if(o.setTransform(1,0,0,1,0,0),o.clearRect(i.x,i.y,i.width,i.height),s){const c=st.shared.setValue(s);c.alpha>0&&(o.globalAlpha=c.alpha,o.fillStyle=c.toHex(),o.fillRect(i.x,i.y,i.width,i.height),o.globalAlpha=1)}}finishRenderPass(){}copyToTexture(t,e,s,n,a){const i=this._renderTargetSystem.getGpuRenderTarget(t).canvas,c=e.source,{context:h}=this._ensureCanvas(c),l=(a==null?void 0:a.x)??0,f=(a==null?void 0:a.y)??0;return h.drawImage(i,s.x,s.y,n.width,n.height,l,f,n.width,n.height),c.update(),e}destroyGpuRenderTarget(t){}_ensureCanvas(t){let e=t.resource;(!e||!fe.test(e))&&(e=V.get().createCanvas(t.pixelWidth,t.pixelHeight),t.resource=e),(e.width!==t.pixelWidth||e.height!==t.pixelHeight)&&(e.width=t.pixelWidth,e.height=t.pixelHeight);const s=e.getContext("2d");return{canvas:e,context:s}}}class Kt extends Ce{constructor(t){super(t),this.adaptor=new Le,this.adaptor.init(t,this)}}Kt.extension={type:[T.CanvasSystem],name:"renderTarget"};class Qt{constructor(t){}init(){}initSource(t){}generateCanvas(t){const e=V.get().createCanvas(),s=e.getContext("2d"),n=d.getCanvasSource(t);if(!n)return e;const a=t.frame,o=t.source._resolution??t.source.resolution??1,i=a.x*o,c=a.y*o,h=a.width*o,l=a.height*o;return e.width=Math.ceil(h),e.height=Math.ceil(l),s.drawImage(n,i,c,h,l,0,0,h,l),e}getPixels(t){const e=this.generateCanvas(t);return{pixels:e.getContext("2d",{willReadFrequently:!0}).getImageData(0,0,e.width,e.height).data,width:e.width,height:e.height}}destroy(){}}Qt.extension={type:[T.CanvasSystem],name:"texture"};const Ne=[...ye,Xt,$t,Qt,Kt],Ye=[_e,ve,be,Te,Me,zt,Yt,Se],je=[Re,Jt],Zt=[],te=[],ee=[];$.handleByNamedList(T.CanvasSystem,Zt);$.handleByNamedList(T.CanvasPipes,te);$.handleByNamedList(T.CanvasPipesAdaptor,ee);$.add(...Ne,...Ye,...je);class Je extends ge{constructor(){const t={name:"canvas",type:me.CANVAS,systems:Zt,renderPipes:te,renderPipeAdaptors:ee};super(t)}}export{Je as CanvasRenderer};
